import vscode = require('vscode');

import path = require('path');
import fs = require('fs');
import readline = require("readline");

function provideDefinition(document, position, token) {
    const fileName    = document.fileName;
    const workDir     = path.dirname(fileName);
    const word        = document.getText(document.getWordRangeAtPosition(position));

    if (fileName.endsWith(".pybc")) {
        let destPath = `${workDir}/Python/ceval.c`;
        let table = {'POP_TOP': 1356,
        'ROT_TWO': 1362,
        'ROT_THREE': 1370,
        'DUP_TOP': 1392,
        'DUP_TOP_TWO': 1399,
        'ROT_FOUR': 1380,
        'NOP': 1324,
        'UNARY_POSITIVE': 1410,
        'UNARY_NEGATIVE': 1420,
        'UNARY_NOT': 1430,
        'UNARY_INVERT': 1448,
        'BINARY_MATRIX_MULTIPLY': 1482,
        'INPLACE_MATRIX_MULTIPLY': 1696,
        'BINARY_POWER': 1458,
        'BINARY_MULTIPLY': 1470,
        'BINARY_MODULO': 1518,
        'BINARY_ADD': 1538,
        'BINARY_SUBTRACT': 1564,
        'BINARY_SUBSCR': 1576,
        'BINARY_FLOOR_DIVIDE': 1506,
        'BINARY_TRUE_DIVIDE': 1494,
        'INPLACE_FLOOR_DIVIDE': 1720,
        'INPLACE_TRUE_DIVIDE': 1708,
        'GET_AITER': 1912,
        'GET_ANEXT': 1956,
        'BEFORE_ASYNC_WITH': 3232,
        'BEGIN_FINALLY': 2185,
        'END_ASYNC_FOR': 2224,
        'INPLACE_ADD': 1744,
        'INPLACE_SUBTRACT': 1763,
        'INPLACE_MULTIPLY': 1684,
        'INPLACE_MODULO': 1732,
        'STORE_SUBSCR': 1835,
        'DELETE_SUBSCR': 1851,
        'BINARY_LSHIFT': 1588,
        'BINARY_RSHIFT': 1600,
        'BINARY_AND': 1612,
        'BINARY_XOR': 1624,
        'BINARY_OR': 1636,
        'INPLACE_POWER': 1672,
        'GET_ITER': 3151,
        'GET_YIELD_FROM_ITER': 3164,
        'PRINT_EXPR': 1865,
        'LOAD_BUILD_CLASS': 2244,
        'YIELD_FROM': 2043,
        'GET_AWAITABLE': 2007,
        'INPLACE_LSHIFT': 1775,
        'INPLACE_RSHIFT': 1787,
        'INPLACE_AND': 1799,
        'INPLACE_XOR': 1811,
        'INPLACE_OR': 1823,
        'WITH_CLEANUP_START': 3295,
        'WITH_CLEANUP_FINISH': 3366,
        'RETURN_VALUE': 1906,
        'IMPORT_STAR': 2997,
        'SETUP_ANNOTATIONS': 2803,
        'YIELD_VALUE': 2077,
        'POP_BLOCK': 2118,
        'END_FINALLY': 2193,
        'POP_EXCEPT': 2094,
        'STORE_NAME': 2275,
        'DELETE_NAME': 2296,
        'UNPACK_SEQUENCE': 2315,
        'FOR_ITER': 3193,
        'UNPACK_EX': 2346,
        'STORE_ATTR': 2361,
        'DELETE_ATTR': 2375,
        'STORE_GLOBAL': 2386,
        'DELETE_GLOBAL': 2397,
        'LOAD_CONST': 1341,
        'LOAD_NAME': 2411,
        'BUILD_TUPLE': 2672,
        'BUILD_LIST': 2684,
        'BUILD_SET': 2739,
        'BUILD_MAP': 2779,
        'LOAD_ATTR': 2958,
        'COMPARE_OP': 2969,
        'IMPORT_NAME': 2983,
        'IMPORT_FROM': 3020,
        'JUMP_FORWARD': 3031,
        'JUMP_IF_FALSE_OR_POP': 3085,
        'JUMP_IF_TRUE_OR_POP': 3109,
        'JUMP_ABSOLUTE': 3134,
        'POP_JUMP_IF_FALSE': 3036,
        'POP_JUMP_IF_TRUE': 3060,
        'LOAD_GLOBAL': 2475,
        'SETUP_FINALLY': 3221,
        'LOAD_FAST': 1328,
        'STORE_FAST': 1349,
        'DELETE_FAST': 2561,
        'RAISE_VARARGS': 1884,
        'CALL_FUNCTION': 3489,
        'MAKE_FUNCTION': 3564,
        'BUILD_SLICE': 3597,
        'LOAD_CLOSURE': 2587,
        'LOAD_DEREF': 2633,
        'STORE_DEREF': 2645,
        'DELETE_DEREF': 2575,
        'CALL_FUNCTION_KW': 3502,
        'CALL_FUNCTION_EX': 3519,
        'SETUP_WITH': 3266,
        'EXTENDED_ARG': 3675,
        'LIST_APPEND': 1648,
        'SET_ADD': 1660,
        'MAP_ADD': 2941,
        'LOAD_CLASSDEREF': 2594,
        'BUILD_LIST_UNPACK': 2698,
        'BUILD_MAP_UNPACK': 2895,
        'BUILD_MAP_UNPACK_WITH_CALL': 2920,
        'BUILD_TUPLE_UNPACK': 2697,
        'BUILD_SET_UNPACK': 2760,
        'SETUP_ASYNC_WITH': 3256,
        'FORMAT_VALUE': 3615,
        'BUILD_CONST_KEY_MAP': 2862,
        'BUILD_STRING': 2654,
        'BUILD_TUPLE_UNPACK_WITH_CALL': 2696,
        'LOAD_METHOD': 3403,
        'CALL_METHOD': 3440,
        'CALL_FINALLY': 2175,
        'POP_FINALLY': 2124};
        return new vscode.Location(vscode.Uri.file(destPath), new vscode.Position(table[word], 0));

    }
};

module.exports = function(context) {
    // 注册如何实现跳转到定义，第一个参数表示仅对json文件生效
    context.subscriptions.push(vscode.languages.registerDefinitionProvider(['*'], {
        provideDefinition
    }));
};